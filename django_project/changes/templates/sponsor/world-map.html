{% load static %}

{% block js_head %}
<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration
            const config = {
                options: {
                    display: 'Sustaining Member Count',
                    value: 'normalized_membership_value',
                    attr: ''
                },
                levels: JSON.parse('{{ levels_json|safe }}'),
                geoJsonData: JSON.parse('{{ sponsors_geojson|escapejs|safe }}'),
                mapCenter: [0, 0],
                mapZoom: 2.5
            };

            console.log(config.geoJsonData);
            const key = 'RRZE1RR1wXXDMtJpO9Gn';

            const attribution = new ol.control.Attribution({
                collapsible: false,
            });

            const source = new ol.source.TileJSON({
                url: `https://api.maptiler.com/maps/topo-v2/tiles.json?key=${key}`, // source URL
                tileSize: 512,
                crossOrigin: 'anonymous'
            });
          
            // Initialize OpenLayers Map
            const map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: new ol.View({
                    projection: 'EPSG:4326',
                    center: config.mapCenter,
                    zoom: config.mapZoom
                })
            });
          
            // Initialize controls and layers
            // initMapControls(map, config);
            loadGeoJsonData(map, config);
        });
        
        function initMapControls(map, config) {
            // Initialize info panel
            const infoPanel = new InfoPanel(config);
            map.addControl(infoPanel);
            
            // Initialize legend
            const legend = new LegendControl(config);
            map.addControl(legend);
            
            // Initialize options selector
            const optionsControl = new OptionsControl(config);
            map.addControl(optionsControl);
            
            // Initialize sponsor levels
            initSponsorLevels(config.levels);
        }
        
        function loadGeoJsonData(map, config) {
            console.log(typeof config.geoJsonData);
            const vectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: new ol.format.GeoJSON().readFeatures(config.geoJsonData)
                }),
                style: feature => getFeatureStyle(feature, config)
            });
            map.addLayer(vectorLayer);
        }

        function getFeatureStyle(feature, config) {
            const value = feature.get(config.options.value);
            const color = getColor(value);
            if (value > 0) {
                return new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: color + 'BF' // Adding transparency (75% opacity)
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#fff',
                        width: 1
                    })
                });
            }
        }
        // Color scale function
        function getColor(value) {
            const transparency = 'BF'; // 75% transparency
            if (value > 0.00000005) return '#00441b';
            if (value > 0.00000002) return '#006d2c';
            if (value > 0.00000001) return '#238b45';
            if (value > 0.000000005) return '#41ab5d';
            if (value > 0.000000001) return '#74c476';
            if (value > 0) return '#e5f5e0';
        }

    </script>
{% endblock %}

{% block content %}
    <div class="card">
        <header class="card-header">
            <p class="card-header-title">
                World Map of Sustaining Members
            </p>
        </header>
        <div class="card-content">
            <div class="content">
                <div class="container">
                    <div class="container-fluid">
                        <div class="row" id="map"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="levels"></div>
{% endblock %}